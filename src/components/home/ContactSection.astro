---
import PhoneNumberInput from "../ui/PhoneNumberInput";
---

<section id="contact" class="scroll-offset mb-16 md:mb-20 perspective-1000">
  <div
    class="bg-gray-900 border border-gray-800 rounded-3xl p-8 md:p-16 text-center text-white relative overflow-hidden transition-all duration-500 ease-out will-change-transform group will-change-[max-width] mx-auto"
    id="contact-container"
    style="min-height: 400px;"
  >
    <!-- Background Tech Effects -->
    <div
      class="absolute top-0 right-0 -mt-10 -mr-10 w-64 h-64 bg-purple-600 rounded-full blur-3xl opacity-20 pointer-events-none"
    >
    </div>
    <div
      class="absolute bottom-0 left-0 -mb-10 -ml-10 w-64 h-64 bg-cyan-500 rounded-full blur-3xl opacity-20 pointer-events-none"
    >
    </div>

    <!-- Grid Pattern Overlay (Tech Feel) -->
    <div
      class="absolute inset-0 bg-[url('/grid-pattern.svg')] opacity-5 pointer-events-none"
    >
    </div>

    <!-- Scanner Beam (Hidden by default) -->
    <div
      id="scanner-beam"
      class="absolute top-0 left-0 w-full h-[2px] bg-gradient-to-r from-transparent via-cyan-400 to-transparent shadow-[0_0_15px_rgba(34,211,238,0.8)] opacity-0 z-20 pointer-events-none"
    >
    </div>

    <div
      class="relative z-10 max-w-2xl mx-auto h-full flex flex-col justify-center"
    >
      <!-- Initial View -->
      <div
        id="contact-initial"
        class="transition-all duration-500 ease-out transform origin-center"
      >
        <h2 class="text-3xl md:text-4xl font-bold mb-6 tracking-tight">
          Let's <span
            class="text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-500"
            >Collaborate</span
          >
        </h2>
        <p class="text-gray-300 text-lg mb-10 max-w-xl mx-auto leading-relaxed">
          Ready to build something extraordinary? Initialize the protocol and
          let's establish a connection.
        </p>

        <div class="flex flex-col items-center gap-8">
          <button
            id="get-in-touch-btn"
            class="group relative inline-flex items-center justify-center px-10 py-4 font-bold text-white transition-all duration-200 bg-gray-800 font-lg rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 overflow-hidden"
          >
            <span
              class="absolute inset-0 w-full h-full -mt-1 rounded-lg opacity-30 bg-gradient-to-b from-transparent via-transparent to-gray-700"
            ></span>
            <span class="relative z-10 flex items-center gap-3">
              <span>INITIALIZE UPLINK</span>
              <svg
                class="w-5 h-5 group-hover:translate-x-1 transition-transform"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
                ><path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg
              >
            </span>
            <div
              class="absolute inset-0 rounded-full ring-2 ring-white/10 group-hover:ring-cyan-400/50 transition-all duration-300"
            >
            </div>
            <div
              class="absolute inset-0 bg-gradient-to-r from-cyan-500/20 to-purple-500/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300"
            >
            </div>
          </button>

          <!-- Social Links -->
          <div class="flex gap-6 items-center justify-center" id="social-links">
            <a
              href="https://github.com/hafizbahtiar"
              target="_blank"
              rel="noopener noreferrer"
              class="text-gray-400 hover:text-white transition-all transform hover:scale-110 hover:text-cyan-400"
              aria-label="GitHub"
            >
              <svg
                class="w-8 h-8"
                fill="currentColor"
                viewBox="0 0 24 24"
                aria-hidden="true"
                ><path
                  fill-rule="evenodd"
                  d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z"
                  clip-rule="evenodd"></path></svg
              >
            </a>
            <a
              href="https://www.linkedin.com/in/hafizbahtiar/"
              target="_blank"
              rel="noopener noreferrer"
              class="text-gray-400 hover:text-white transition-all transform hover:scale-110 hover:text-cyan-400"
              aria-label="LinkedIn"
            >
              <svg
                class="w-8 h-8"
                fill="currentColor"
                viewBox="0 0 24 24"
                aria-hidden="true"
                ><path
                  fill-rule="evenodd"
                  d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"
                  clip-rule="evenodd"></path></svg
              >
            </a>
          </div>
        </div>
      </div>

      <!-- Contact Form (Hidden by default) -->
      <div
        id="contact-form"
        class="hidden absolute inset-0 w-full h-full flex flex-col justify-center px-4 md:px-0"
      >
        <div class="w-full max-w-lg mx-auto">
          <div
            id="contact-header"
            class="flex justify-between items-center mb-6 form-item opacity-0 translate-y-4"
          >
            <h2 class="text-2xl md:text-3xl font-bold flex items-center gap-2">
              <span class="w-2 h-8 bg-cyan-500 rounded-full block"></span>
              Secure Channel
            </h2>
            <button
              id="back-to-initial"
              class="text-gray-500 hover:text-cyan-400 transition-colors p-2 hover:bg-gray-800 rounded-full"
            >
              <svg
                class="w-6 h-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>

          <div
            id="form-status"
            class="hidden text-sm font-mono text-center p-3 rounded-lg border mb-4"
          >
          </div>

          <!-- Success View (Initially Hidden) -->
          <div
            id="success-view"
            class="hidden flex flex-col items-center justify-center text-center space-y-6 animate-fade-in"
          >
            <div class="relative w-20 h-20">
              <div
                class="absolute inset-0 bg-green-500/20 rounded-full animate-ping"
              >
              </div>
              <div
                class="relative z-10 w-20 h-20 bg-green-500 rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(34,197,94,0.5)]"
              >
                <svg
                  class="w-10 h-10 text-white"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="3"
                    d="M5 13l4 4L19 7"></path>
                </svg>
              </div>
            </div>

            <div>
              <h3 class="text-2xl font-bold text-white mb-2">
                TRANSMISSION COMPLETE
              </h3>
              <p class="text-gray-300" id="success-message">
                Message successfully relayed to HQ.
              </p>
            </div>

            <button
              id="send-another-btn"
              class="mt-4 px-6 py-2 bg-gray-800 hover:bg-gray-700 text-cyan-400 border border-cyan-500/30 rounded-lg transition-all text-sm font-mono tracking-wider hover:shadow-[0_0_15px_rgba(6,182,212,0.2)]"
            >
              ESTABLISH NEW UPLINK
            </button>
          </div>

          <!-- Actual Form -->
          <form class="space-y-5 text-left" id="main-contact-form">
            <div
              class="form-item opacity-0 translate-x-10 transition-all duration-500 delay-100"
            >
              <label
                for="name"
                class="block text-xs font-mono text-cyan-500 mb-1 uppercase tracking-wider"
                >Identity</label
              >
              <div class="relative group">
                <input
                  type="text"
                  id="name"
                  name="name"
                  class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500 outline-none transition-all placeholder-gray-600"
                  placeholder="Enter your name"
                  maxlength="256"
                />
                <div
                  class="absolute inset-0 rounded-lg bg-cyan-500/5 opacity-0 group-hover:opacity-100 pointer-events-none transition-opacity"
                >
                </div>
              </div>
            </div>

            <div
              class="form-item opacity-0 -translate-x-10 transition-all duration-500 delay-200"
            >
              <label
                for="email"
                class="block text-xs font-mono text-cyan-500 mb-1 uppercase tracking-wider"
                >Coordinates (Email)</label
              >
              <input
                type="email"
                id="email"
                name="email"
                class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500 outline-none transition-all placeholder-gray-600"
                placeholder="email@example.com"
              />
            </div>

            <PhoneNumberInput
              className="opacity-0 translate-x-10 transition-all duration-500 delay-300"
            />

            <div
              class="form-item opacity-0 -translate-x-10 transition-all duration-500 delay-400"
            >
              <label
                for="message"
                class="block text-xs font-mono text-cyan-500 mb-1 uppercase tracking-wider"
                >Transmission Data</label
              >
              <div class="relative">
                <textarea
                  id="message"
                  name="message"
                  rows="4"
                  class="w-full bg-gray-800/50 border border-gray-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500 outline-none transition-all resize-none placeholder-gray-600"
                  placeholder="Your message..."
                  maxlength="2500"></textarea>
                <span
                  class="absolute right-3 bottom-3 text-xs font-mono text-gray-600"
                  >0 / 2500</span
                >
              </div>
            </div>

            <button
              type="submit"
              id="submit-btn"
              class="form-item opacity-0 translate-y-4 w-full bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-4 px-8 rounded-lg transition-all transform hover:-translate-y-1 shadow-[0_0_20px_rgba(6,182,212,0.3)] relative overflow-hidden group delay-500"
            >
              <span
                class="relative z-10 flex items-center justify-center gap-2"
              >
                SEND TRANSMISSION
                <svg
                  class="w-4 h-4"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  ><path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg
                >
              </span>
              <div
                class="absolute inset-0 bg-white/10 translate-y-full group-hover:translate-y-0 transition-transform duration-300"
              >
              </div>
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .perspective-1000 {
    perspective: 1000px;
  }

  @keyframes scan {
    0% {
      top: 0;
      opacity: 0;
    }
    10% {
      opacity: 1;
    }
    90% {
      opacity: 1;
    }
    100% {
      top: 100%;
      opacity: 0;
    }
  }

  .scanning {
    animation: scan 0.8s cubic-bezier(0.45, 0, 0.55, 1) forwards;
  }

  .tech-border-glow {
    box-shadow:
      0 0 15px rgba(6, 182, 212, 0.5),
      inset 0 0 10px rgba(6, 182, 212, 0.2);
    border-color: rgba(6, 182, 212, 0.6);
  }

  .contact-form-active {
    border-radius: 24px;
  }

  @media (min-width: 768px) {
    .contact-form-active {
      max-width: 640px;
    }
  }
</style>

<script>
  import { submitContactForm } from "../../lib/contact";

  const getInTouchBtn = document.getElementById("get-in-touch-btn");
  const backBtn = document.getElementById("back-to-initial");
  const initialView = document.getElementById("contact-initial");
  const formView = document.getElementById("contact-form");
  const container = document.getElementById("contact-container");
  const scannerBeam = document.getElementById("scanner-beam");
  const contactHeader = document.getElementById("contact-header");
  const formItems = document.querySelectorAll(".form-item");

  const contactForm = document.getElementById(
    "main-contact-form",
  ) as HTMLFormElement;
  const submitBtn = document.getElementById("submit-btn") as HTMLButtonElement;
  const statusDiv = document.getElementById("form-status");
  const successView = document.getElementById("success-view");
  const successMessage = document.getElementById("success-message");
  const sendAnotherBtn = document.getElementById("send-another-btn");
  const applyFormWidth = (active: boolean) => {
    if (!container || !formView) return;
    const isDesktop = window.matchMedia("(min-width: 768px)").matches;
    const currentWidth = container.offsetWidth;
    const parentWidth = container.parentElement?.offsetWidth ?? currentWidth;
    const formWidth = formView.offsetWidth;
    const padding = 64;
    const targetWidth = active && isDesktop ? formWidth + padding : parentWidth;
    container.style.maxWidth = `${currentWidth}px`;
    container.style.width = "100%";
    requestAnimationFrame(() => {
      container.style.maxWidth = `${targetWidth}px`;
    });
  };

  if (
    getInTouchBtn &&
    backBtn &&
    initialView &&
    formView &&
    container &&
    scannerBeam &&
    contactForm &&
    submitBtn &&
    statusDiv
  ) {
    // Calculate initial height to prevent jump
    let initialHeight = container.offsetHeight;
    container.style.height = `${initialHeight}px`;
    const parentWidth =
      container.parentElement?.offsetWidth ?? container.offsetWidth;
    container.style.maxWidth = `${parentWidth}px`;
    container.style.width = "100%";

    getInTouchBtn.addEventListener("click", () => {
      // 1. Activate Scanner & Tech Effects
      scannerBeam.classList.add("scanning");
      container.classList.add("tech-border-glow");
      container.classList.add("contact-form-active");

      // 2. Retract Initial View
      initialView.style.transform = "scale(0.9) translateY(20px)";
      initialView.style.opacity = "0";

      setTimeout(() => {
        initialView.classList.add("hidden");
        formView.classList.remove("hidden");

        // 3. Resize Container
        formView.classList.remove("absolute", "inset-0");
        const formHeight = formView.offsetHeight + 128;
        container.style.height = `${Math.max(formHeight, 600)}px`;
        requestAnimationFrame(() => {
          applyFormWidth(true);
        });

        // 4. Animate Form Items In (Staggered)
        setTimeout(() => {
          formItems.forEach((item) => {
            (item as HTMLElement).style.opacity = "1";
            (item as HTMLElement).style.transform = "translate(0, 0)";
          });
        }, 300);

        // Remove scanner after animation
        setTimeout(() => {
          scannerBeam.classList.remove("scanning");
          container.classList.remove("tech-border-glow");
        }, 800);
      }, 400);
    });

    backBtn.addEventListener("click", () => {
      closeForm();
    });

    function closeForm() {
      // 1. Retract Form
      formItems.forEach((item) => {
        (item as HTMLElement).style.opacity = "0";
        (item as HTMLElement).style.transform = "translateY(10px)";
      });

      // 2. Shrink Container & Show Initial
      setTimeout(() => {
        if (!formView || !initialView || !container) return;

        formView.classList.add("hidden");
        formView.classList.add("absolute", "inset-0");

        // Hide Success View if active
        if (successView && !successView.classList.contains("hidden")) {
          successView.classList.add("hidden");
          contactForm?.classList.remove("hidden");
          contactHeader?.classList.remove("hidden");
        }

        initialView.classList.remove("hidden");
        // Force reflow
        void initialView.offsetWidth;

        // Restore Initial View
        initialView.style.transform = "scale(1) translateY(0)";
        initialView.style.opacity = "1";

        // Restore Height
        container.style.height = `${initialHeight}px`;
        applyFormWidth(false);
        container.classList.remove("contact-form-active");

        // Clean up styles on form items
        setTimeout(() => {
          formItems.forEach((item) => {
            (item as HTMLElement).style.opacity = "";
            (item as HTMLElement).style.transform = "";
          });
          // Reset form inputs
          contactForm?.reset();
          if (statusDiv) statusDiv.classList.add("hidden");
        }, 500);
      }, 400);
    }

    if (sendAnotherBtn) {
      sendAnotherBtn.addEventListener("click", () => {
        // Reset to form view
        successView?.classList.add("hidden");
        contactForm?.classList.remove("hidden");
        contactHeader?.classList.remove("hidden");
        contactForm?.reset();

        // Animate form items back in
        formItems.forEach((item) => {
          (item as HTMLElement).style.opacity = "0";
          (item as HTMLElement).style.transform = "translateY(10px)";
        });

        setTimeout(() => {
          formItems.forEach((item) => {
            (item as HTMLElement).style.opacity = "1";
            (item as HTMLElement).style.transform = "translate(0, 0)";
          });
        }, 100);
      });
    }

    window.addEventListener("resize", () => {
      applyFormWidth(container.classList.contains("contact-form-active"));
    });

    // Character count for message
    const messageInput = document.getElementById(
      "message",
    ) as HTMLTextAreaElement;
    if (messageInput) {
      messageInput.addEventListener("input", function () {
        const currentLength = this.value.length;
        const counter = this.nextElementSibling;
        if (counter) {
          counter.textContent = `${currentLength} / 2500`;
        }
      });
    }

    // Handle Form Submission
    contactForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const originalBtnContent = submitBtn.innerHTML;

      // Reset status
      statusDiv.classList.add("hidden");
      statusDiv.className =
        "hidden text-sm font-mono text-center p-3 rounded-lg border mb-4";

      // Get data
      const formData = new FormData(contactForm);
      const phoneValue = (formData.get("phone") as string)?.trim();
      const data = {
        name: (formData.get("name") as string).trim(),
        email: (formData.get("email") as string).trim(),
        phone: phoneValue ? phoneValue : undefined,
        message: (formData.get("message") as string).trim(),
        source: "FORM", // Changed to match DB constraint
      };

      // Basic validation
      if (!data.name || !data.email || !data.message) {
        statusDiv.textContent = "All fields are required.";
        statusDiv.classList.remove("hidden");
        statusDiv.classList.add(
          "bg-red-900/50",
          "border-red-500/50",
          "text-red-200",
        );
        return;
      }

      // Loading state
      submitBtn.disabled = true;
      submitBtn.innerHTML =
        '<span class="relative z-10 flex items-center justify-center gap-2"><svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> UPLOADING DATA STREAM...</span><div class="absolute inset-0 bg-white/5"></div>';

      try {
        const result = await submitContactForm(data);

        if (result.success) {
          // Success State - Switch to Success View
          contactForm.classList.add("hidden");
          contactHeader?.classList.add("hidden");
          if (successView) {
            successView.classList.remove("hidden");
            if (successMessage) {
              successMessage.textContent =
                result.message || "Message successfully relayed to HQ.";
            }
          }
          // Reset button for next time
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnContent;
        } else {
          // Error State
          throw new Error(result.error || "Transmission failed.");
        }
      } catch (error: any) {
        console.error("Submission error:", error);
        submitBtn.disabled = false;
        submitBtn.innerHTML =
          '<span class="relative z-10 flex items-center justify-center gap-2 text-red-200"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> UPLINK FAILED</span>';

        statusDiv.textContent =
          error.message || "Connection error. Please retry transmission.";
        statusDiv.classList.remove("hidden");
        statusDiv.classList.add(
          "bg-red-900/50",
          "border-red-500/50",
          "text-red-200",
        );

        // Reset button text after delay
        setTimeout(() => {
          submitBtn.innerHTML = originalBtnContent;
        }, 3000);
      }
    });
  }
</script>
