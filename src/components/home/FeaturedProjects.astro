---
import ProjectCard from "../project/ProjectCard.astro";
import { getProjects } from "../../lib/projects";
import type { Project } from "../../types/project";
import jomDapur from "../../assets/projects/jom-dapur.jpg";
import jdManagement from "../../assets/projects/jd-management.png";
import invois from "../../assets/projects/invois/invois.png";

const localImageMap = new Map([
  ["/images/projects/jom-dapur.jpg", jomDapur],
  ["/images/projects/jd-management.png", jdManagement],
  ["/images/projects/invois/invois.png", invois],
]);

const resolveImage = (imageUrl?: string) => {
  if (!imageUrl) return undefined;
  return localImageMap.get(imageUrl) ?? imageUrl;
};

let projects: Project[] = [];
let hasError = false;

try {
  projects = await getProjects();
} catch {
  hasError = true;
}

const visibleProjects = projects.slice(0, 6).map((project) => ({
  ...project,
  imageUrl: resolveImage(project.imageUrl),
}));
---

{
  hasError ? (
    <div class="text-center py-12 bg-red-900/10 rounded-xl border border-red-900/20">
      <p class="text-red-400 mb-2 font-medium">Failed to load projects</p>
      <p class="text-sm text-gray-400 mb-4">
        Something went wrong while fetching the projects.
      </p>
      <a
        href="/"
        class="inline-flex px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg transition-colors text-sm"
      >
        Try Again
      </a>
    </div>
  ) : visibleProjects.length === 0 ? (
    <div class="text-center py-16 bg-gray-900/30 rounded-3xl border border-gray-800 border-dashed">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-800/50 mb-4 text-gray-500">
        <svg
          class="w-8 h-8"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="1.5"
            d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
          ></path>
        </svg>
      </div>
      <h3 class="text-xl font-bold text-white mb-2">No Projects Found</h3>
      <p class="text-gray-400 max-w-md mx-auto">
        We couldn't find any projects to display right now. Please check back
        later or view my GitHub profile.
      </p>
    </div>
  ) : (
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      {visibleProjects.map((project) => (
        <ProjectCard
          title={project.title}
          description={project.description}
          imageUrl={project.imageUrl}
          imageVariant={project.imageVariant}
          tags={project.tags || []}
          link={`/projects/${project.slug}`}
        />
      ))}
    </div>
  )
}
