---
import PrivateLayout from "../../../../layouts/PrivateLayout.astro";
import { settingsService } from "../../../../lib/settings";
---

<PrivateLayout title="Change Password">
  <div class="space-y-6">
    <div class="flex justify-between items-center">
      <div class="flex items-center gap-4">
        <a
          href="/admin/settings/security"
          class="text-gray-400 hover:text-white transition-colors"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
        </a>
        <h1 class="text-3xl font-bold text-white tracking-tight">
          Change Password
        </h1>
      </div>
    </div>

    <div
      class="bg-gray-800/50 backdrop-blur-xl border border-gray-700 rounded-xl p-6 max-w-xl"
    >
      <form id="security-settings-form" class="space-y-6">
        <div class="space-y-2">
          <label
            for="settings-current-password"
            class="block text-sm font-medium text-gray-400"
          >
            Current Password
          </label>
          <input
            type="password"
            id="settings-current-password"
            name="currentPassword"
            placeholder="••••••••"
            class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500 outline-none transition-all"
          />
        </div>
        <div class="space-y-2">
          <label
            for="settings-new-password"
            class="block text-sm font-medium text-gray-400"
          >
            New Password
          </label>
          <input
            type="password"
            id="settings-new-password"
            name="newPassword"
            placeholder="••••••••"
            class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500 outline-none transition-all"
          />
        </div>
        <div class="space-y-2">
          <label
            for="settings-confirm-password"
            class="block text-sm font-medium text-gray-400"
          >
            Confirm New Password
          </label>
          <input
            type="password"
            id="settings-confirm-password"
            name="confirmPassword"
            placeholder="••••••••"
            class="w-full bg-gray-900/50 border border-gray-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500 outline-none transition-all"
          />
        </div>
        <button
          type="button"
          id="update-password-btn"
          class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-medium py-2 px-4 rounded-lg transition-colors border border-transparent shadow-lg shadow-cyan-900/20"
        >
          Update Password
        </button>
      </form>
    </div>
  </div>
</PrivateLayout>

<script>
  import { settingsService } from "../../../../lib/settings";

  const passwordBtn = document.getElementById(
    "update-password-btn",
  ) as HTMLButtonElement | null;

  // Update Password
  passwordBtn?.addEventListener("click", async () => {
    if (!passwordBtn) return;
    const form = document.getElementById(
      "security-settings-form",
    ) as HTMLFormElement;
    if (!form) return;

    const formData = new FormData(form);
    const currentPass = formData.get("currentPassword") as string;
    const newPass = formData.get("newPassword") as string;
    const confirmPass = formData.get("confirmPassword") as string;

    if (newPass !== confirmPass) {
      alert("New passwords do not match!");
      return;
    }

    if (!newPass) {
      alert("Please enter a new password");
      return;
    }

    const originalContent = passwordBtn.innerHTML;
    passwordBtn.innerHTML = "UPDATING...";
    passwordBtn.disabled = true;

    try {
      // Assuming user ID 1 for owner
      await settingsService.updatePassword(1, currentPass, newPass);
      alert("Password updated successfully!");
      form.reset();
    } catch (error) {
      console.error(error);
      alert("Failed to update password.");
    } finally {
      passwordBtn.innerHTML = originalContent;
      passwordBtn.disabled = false;
    }
  });
</script>
